-- COMPARACIÓN ENTRE ORO Y PLATINO POR AÑO (DIFERENCIA EN USD Y %)
WITH precios_filtrados AS (
    SELECT 
        id_metal,
        YEAR(fecha_hora) AS año,
        AVG(precio_venta) AS precio_medio
    FROM precios
    WHERE id_metal IN (1, 4) AND divisa = 'USD'
    GROUP BY id_metal, YEAR(fecha_hora)
),
comparacion AS (
    SELECT 
        oro.año,
        oro.precio_medio AS precio_oro,
        platino.precio_medio AS precio_platino,
        ROUND(oro.precio_medio - platino.precio_medio, 2) AS diferencia_dolares,
        CAST(ROUND(((oro.precio_medio - platino.precio_medio) / platino.precio_medio * 100), 2) AS VARCHAR) + '%' AS diferencia_porcentaje
        ROUND(oro.precio_medio / platino.precio_medio, 2) AS ratio_oro_platino
    FROM precios_filtrados oro
    INNER JOIN precios_filtrados platino 
        ON oro.año = platino.año
    WHERE oro.id_metal = 1 AND platino.id_metal = 4
)
SELECT 
    año,
    ROUND(precio_oro, 2) AS precio_oro,
    ROUND(precio_platino, 2) AS precio_platino,
    diferencia_dolares,
    diferencia_porcentaje
FROM comparacion
ORDER BY año;
